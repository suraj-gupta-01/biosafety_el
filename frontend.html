<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Detection Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
        }

        .status-badge {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 14px;
        }

        .status-active {
            background: #10b981;
            color: white;
        }

        .status-alert {
            background: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }

        .status-disconnected {
            background: #6b7280;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 16/9;
        }

        #webcam {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-box h3 {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .stat-box p {
            font-size: 14px;
            opacity: 0.9;
        }

        .ppe-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ppe-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #e5e7eb;
        }

        .ppe-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .status-icon {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .status-detected {
            color: #10b981;
        }

        .status-missing {
            color: #ef4444;
        }

        .confidence-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
        }

        .alerts-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .alert-item {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-item.success {
            background: #d1fae5;
            border-left-color: #10b981;
        }

        .alert-item.error {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .alert-item.warning {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .alert-time {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .logs-container {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 10px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            line-height: 1.5;
        }

        .log-time {
            color: #6b7280;
        }

        .log-warn {
            color: #f59e0b;
        }

        .log-error {
            color: #ef4444;
        }

        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .notification-badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 10px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .bottom-grid {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>üõ°Ô∏è PPE Detection System</h1>
                <p style="color: #666; margin-top: 5px;">Real-time Safety Monitoring Dashboard</p>
            </div>
            <div>
                <span class="status-badge status-disconnected" id="systemStatus">‚óè CONNECTING...</span>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Video Feed -->
            <div class="card">
                <h2>üìπ Live Camera Feed</h2>
                <div class="video-container">
                    <img id="webcam" src="" alt="Waiting for video feed...">
                    <div class="video-overlay">
                        <span id="fps">FPS: 0</span> | Frame: <span id="frameCount">0</span>
                    </div>
                </div>
            </div>

            <!-- Stats & PPE Status -->
            <div>
                <!-- Stats -->
                <div class="card" style="margin-bottom: 20px;">
                    <h2>üìä Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <h3 id="totalDetections">0</h3>
                            <p>Total Detections</p>
                        </div>
                        <div class="stat-box">
                            <h3 id="violations">0</h3>
                            <p>Violations</p>
                        </div>
                        <div class="stat-box">
                            <h3 id="alertsSent">0</h3>
                            <p>Alerts Sent</p>
                        </div>
                        <div class="stat-box">
                            <h3 id="uptime">00:00</h3>
                            <p>Uptime</p>
                        </div>
                    </div>
                </div>

                <!-- PPE Status Table -->
                <div class="card">
                    <h2>‚úÖ PPE Status</h2>
                    <table class="ppe-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Status</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody id="ppeTableBody">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">Waiting for data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bottom Grid -->
        <div class="bottom-grid">
            <!-- Alerts -->
            <div class="card">
                <h2>üîî Alerts & Notifications <span class="notification-badge" id="alertCount">0</span></h2>
                <div class="alerts-container" id="alertsContainer">
                    <div class="alert-item">
                        <strong>System Initializing</strong>
                        <p>Connecting to backend server...</p>
                        <div class="alert-time" id="initTime"></div>
                    </div>
                </div>
            </div>

            <!-- Logs -->
            <div class="card">
                <h2>üìù System Logs</h2>
                <div class="logs-container" id="logsContainer">
                    <div class="log-entry">
                        <span class="log-time">[INIT]</span> Connecting to backend...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        const BACKEND_URL = 'http://localhost:5000';
        const REQUIRED_PPE = ['Coverall', 'Gloves', 'Goggles', 'Hairnet', 'Mask', 'Shoe Cover'];
        
        let socket;
        let state = {
            connected: false,
            startTime: null
        };

        // Initialize WebSocket connection
        function initWebSocket() {
            socket = io(BACKEND_URL);

            socket.on('connect', () => {
                console.log('Connected to backend');
                state.connected = true;
                updateConnectionStatus(true);
                addLog('Connected to backend server', 'info');
            });

            socket.on('disconnect', () => {
                console.log('Disconnected from backend');
                state.connected = false;
                updateConnectionStatus(false);
                addLog('Disconnected from backend server', 'error');
            });

            socket.on('initial_state', (data) => {
                console.log('Received initial state', data);
                updateUI(data);
                if (data.stats && data.stats.start_time) {
                    state.startTime = data.stats.start_time;
                }
            });

            socket.on('new_alert', (alert) => {
                console.log('New alert', alert);
                addAlert(alert.type, alert.title, alert.message);
            });

            socket.on('new_log', (log) => {
                console.log('New log', log);
                addLogEntry(log);
            });
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusBadge = document.getElementById('systemStatus');
            if (connected) {
                statusBadge.className = 'status-badge status-active';
                statusBadge.textContent = '‚óè ACTIVE';
            } else {
                statusBadge.className = 'status-badge status-disconnected';
                statusBadge.textContent = '‚óè DISCONNECTED';
            }
        }

        // Poll for updates
        async function pollUpdates() {
            if (!state.connected) return;

            try {
                const response = await fetch(`${BACKEND_URL}/api/status`);
                const data = await response.json();
                updateUI(data);
            } catch (error) {
                console.error('Error polling updates:', error);
            }
        }

        // Update UI with data
        function updateUI(data) {
            if (!data) return;

            // Update stats
            if (data.stats) {
                document.getElementById('totalDetections').textContent = data.stats.total_detections || 0;
                document.getElementById('violations').textContent = data.stats.violations || 0;
                document.getElementById('alertsSent').textContent = data.stats.alerts_sent || 0;
                document.getElementById('frameCount').textContent = data.stats.frame_count || 0;
                document.getElementById('fps').textContent = `FPS: ${data.stats.fps || 0}`;

                if (data.stats.start_time && !state.startTime) {
                    state.startTime = data.stats.start_time;
                }
            }

            // Update PPE status table
            if (data.ppe_status) {
                updatePPETable(data.ppe_status);
            }

            // Update alerts
            if (data.alerts && data.alerts.length > 0) {
                document.getElementById('alertCount').textContent = data.alerts.length;
            }

            // Check for violations
            if (data.ppe_status) {
                const hasViolations = Object.values(data.ppe_status).some(item => !item.detected);
                const statusBadge = document.getElementById('systemStatus');
                if (hasViolations && state.connected) {
                    statusBadge.className = 'status-badge status-alert';
                    statusBadge.textContent = '‚ö† VIOLATION';
                } else if (state.connected) {
                    statusBadge.className = 'status-badge status-active';
                    statusBadge.textContent = '‚óè ACTIVE';
                }
            }
        }

        // Update PPE table
        function updatePPETable(ppeStatus) {
            const tbody = document.getElementById('ppeTableBody');
            tbody.innerHTML = REQUIRED_PPE.map(item => {
                const status = ppeStatus[item] || { detected: false, confidence: 0 };
                const isDetected = status.detected;
                const confidence = Math.round(status.confidence);

                return `
                    <tr>
                        <td>${item}</td>
                        <td>
                            <span class="status-icon ${isDetected ? 'status-detected' : 'status-missing'}">
                                ‚óè ${isDetected ? 'Detected' : 'Missing'}
                            </span>
                        </td>
                        <td>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidence}%"></div>
                            </div>
                            <small style="color: #666;">${confidence}%</small>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Update uptime
        function updateUptime() {
            if (!state.startTime) return;
            
            const uptime = Math.floor(Date.now() / 1000 - state.startTime);
            const minutes = Math.floor(uptime / 60);
            const seconds = uptime % 60;
            document.getElementById('uptime').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Add alert
        function addAlert(type, title, message) {
            const container = document.getElementById('alertsContainer');
            const alertCount = document.getElementById('alertCount');
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item ${type}`;
            alertDiv.innerHTML = `
                <strong>${title}</strong>
                <p>${message}</p>
                <div class="alert-time">${new Date().toLocaleString()}</div>
            `;
            
            container.insertBefore(alertDiv, container.firstChild);
            
            const count = container.children.length;
            alertCount.textContent = count;

            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Add log entry
        function addLog(message, level = 'info') {
            addLogEntry({
                message: message,
                level: level,
                timestamp: new Date().toLocaleTimeString()
            });
        }

        function addLogEntry(log) {
            const container = document.getElementById('logsContainer');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry ${log.level === 'warn' ? 'log-warn' : log.level === 'error' ? 'log-error' : ''}`;
            
            logDiv.innerHTML = `<span class="log-time">[${log.timestamp}]</span> ${log.message}`;
            
            container.insertBefore(logDiv, container.firstChild);

            while (container.children.length > 50) {
                container.removeChild(container.lastChild);
            }
        }

        // Initialize video feed
        function initVideoFeed() {
            const img = document.getElementById('webcam');
            img.src = `${BACKEND_URL}/api/video-feed`;
            img.onerror = () => {
                console.error('Video feed error');
                setTimeout(() => {
                    img.src = `${BACKEND_URL}/api/video-feed?t=${Date.now()}`;
                }, 2000);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('initTime').textContent = new Date().toLocaleString();
            
            initWebSocket();
            initVideoFeed();
            
            // Poll for updates every 1 second
            setInterval(pollUpdates, 1000);
            
            // Update uptime every second
            setInterval(updateUptime, 1000);
            
            addLog('Dashboard initialized', 'info');
        });
    </script>
</body>
</html>